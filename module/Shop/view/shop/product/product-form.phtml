<?php
$form = $this->form;
$routeArray = ['action' => $this->formAction];
if (isset($this->productId)) $routeArray['id'] = $this->productId;
?>
<div class="row">
	<form class="col-sm-12 form-horizontal" method="post" action="<?=$this->url('admin/shop/product/edit', $routeArray) ?>">

        <div class="row">
            <div class="col-sm-6">
                <fieldset>
                    <legend>Details: 
                    <?php if ($this->formAction == 'edit'):?>
                    <small>(<?=$this->model->getProductId();?>)</small>
                    <?php endif;?>
                    </legend>
                    <div class="row">
                        <div class="col-sm-6 text-right">
                            <label>
                                <?=$this->formCheckbox($form->get('enabled'));?>
                            </label>
                        </div>
                        <div class="col-sm-6 text-right">
                            <label>
                                <?=$this->formCheckbox($form->get('discontinued'));?>
                            </label>
                        </div>
                    </div>

                    <div class="clearfix">&nbsp;</div>
                    
                    <div class="form-group<?php if ($form->get('sku')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="sku"><?=$form->get('sku')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formText($form->get('sku')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('sku'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('name')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="name"><?=$form->get('name')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formText($form->get('name')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('name'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('productCategoryId')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="productCategoryId"><?=$form->get('productCategoryId')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formSelect($form->get('productCategoryId')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('productCategoryId'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('ident')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="ident"><?=$form->get('ident')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formText($form->get('ident')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                If you leave this blank the the product code and title will be used for the ident.
                                <?=$this->formElementErrors($form->get('ident'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('shortDescription')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="shortDescription"><?=$form->get('shortDescription')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formText($form->get('shortDescription')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('shortDescription'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="col-sm-6">
                <fieldset>
                    <legend>Price:</legend>
                    <div class="form-group<?php if ($form->get('productGroupId')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="productGroupId"><?=$form->get('productGroupId')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formSelect($form->get('productGroupId')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('productGroupId'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('price')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="price"><?=$form->get('price')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formNumber($form->get('price')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                Do not include the currency sign or commas.
                                <?=$this->formElementErrors($form->get('price'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('discountPercent')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="discountPercent"><?=$form->get('discountPercent')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formNumber($form->get('discountPercent')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                Do not include the % sign.
                                <?=$this->formElementErrors($form->get('discountPercent'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('quantity')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="quantity"><?=$form->get('quantity')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formNumber($form->get('quantity')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('quantity'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('taxCodeId')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="taxCodeId"><?=$form->get('taxCodeId')->getLabel();?></label>
                        <div class="col-sm-8">
                            <?=$this->formSelect($form->get('taxCodeId')->setAttribute('class', 'form-control')); ?>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('taxCodeId'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-4 text-right">
                            <label>
                                <?=$this->formCheckbox($form->get('addPostage'));?>
                            </label>
                        </div>
                        <div class="col-sm-4 text-right">
                            <label>
                                <?=$this->formCheckbox($form->get('vatInc'));?>
                            </label>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="col-sm-6">
                <fieldset>
                    <legend>Attributes:</legend>
                    <div class="col-md-12 col-md-offset-4">
                        <label>
                            <?=$this->FormCheckbox($form->get('showImage'));?>
                        </label>
                    </div>
                    <div class="form-group<?php if ($form->get('productSizeId')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="productSizeId"><?=$form->get('productSizeId')->getLabel();?></label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <?=$this->formSelect($form->get('productSizeId')->setAttribute('class', 'form-control')); ?>
                                <span class="input-group-btn">
                                    <a href="#" id="add-size-button" class="btn btn-default" data-toggle="modal" data-target="#product-size-model">New Size</a>
                                </span>
                            </div>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('productSizeId'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>

                    <div class="form-group<?php if ($form->get('postUnitId')->getMessages()) echo ' has-error'; ?>">
                        <label class="col-sm-4 control-label" for="postUnitId"><?=$form->get('postUnitId')->getLabel();?></label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <?=$this->formSelect($form->get('postUnitId')->setAttribute('class', 'form-control')); ?>
                                <span class="input-group-btn">
                                    <a href="#" id="add-weight-button" class="btn btn-default" data-toggle="modal" data-target="#product-weight-model">New Weight</a>
                                </span>
                            </div>
                            <span class="help-block">
                                <?=$this->formElementErrors($form->get('postUnitId'), [
                                    'class' => 'list-unstyled'
                                ]); ?>
                            </span>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="col-md-12">
                <fieldset>
                    <legend><?=$form->get('description')->getLabel();?></legend>
                    <?=$this->formTextarea($form->get('description')); ?>
                    <span class="help-block<?php if ($form->get('description')->getMessages()) echo ' has-error'; ?>">
                        <?=$this->formElementErrors($form->get('description'), [
                            'class' => 'list-unstyled'
                        ]); ?>
                    </span>
                </fieldset>
            </div>

        </div>

        <?php if ($this->formAction == 'add'): ?>
        <?=$this->formElement($form->get('redirectToEdit'));?>
        <?php endif; ?>

        <?=$this->formElement($form->get('productId'));?>

        <input type="hidden" name="action" value="<?=$this->formAction;?>">

        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-primary" data-loading-text="Please wait...">
                    Submit
                </button>
                <button type="button" class="btn btn-warning"  data-loading-text="Please wait..." onClick="window.location = '<?=$this->url('admin/shop/product') ?>';">
                    Cancel
                </button>
            </div>
        </div>

	</form>
</div>

<div id="product-size-model" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add Product Size</h4>
            </div>
            <div class="modal-body">
                <i class="fa fa-spinner fa-spin"></i>&nbsp;Loading
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="edit-product-size-save" type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="product-weight-model" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add Product Weight</h4>
            </div>
            <div class="modal-body">
                <i class="fa fa-spinner fa-spin"></i>&nbsp;Loading
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="edit-product-weight-save" type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<?php $this->inlineScript()
    ->appendFile($this->themePath('/assets/js/LiveEditor/scripts/innovaeditor.js'))
    ->appendFile($this->themePath('/assets/js/LiveEditor/scripts/jquery.innovaeditor.js'));?>

<script type="text/javascript">
    $(document).ready(function(){
        var loadSizes;
        $('#product-textarea').liveEdit({
            height : 500,
            css: [
                'http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css',
                'http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css',
                'http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css'
            ] /* Apply bootstrap css into the editing area */ ,
            groups: [
                ["group1", "", ["Bold", "Italic", "Underline", "ForeColor", "RemoveFormat"]],
                ["group2", "", ["Bullets", "Numbering", "Indent", "Outdent"]],
                ["group3", "", ["Paragraph", "FontSize", "FontDialog", "TextDialog"]],
                ["group4", "", ["LinkDialog", "TableDialog", "Snippets"]],
                ["group5", "", ["Undo", "Redo", "FullScreen"]]
            ] /* Toolbar configuration */ ,
            fileBrowser: '<?=$this->basePath('/admin/asset-manager')?>'
        });
        $('#product-textarea').data('liveEdit').startedit(); /* Run the Editor */

        $('#product-size-model').on('show.bs.modal', function(){
            $(this).find('.modal-body').load('<?=$this->url('admin/shop/product/size/edit', [
                'action'    => 'add',
            ]);?>');
        });

        $('#product-size-model').on('hide.bs.modal', function (e) {
            $(this).find('.modal-body').html('<i class="fa fa-spinner fa-spin"></i>&nbsp;Loading');
        });

        $('#edit-product-size-save').on('click', function() {
            el = $('#product-size-model');
            el.find('.modal-content').loadingOverlay({
                loadingText: 'Please wait while I update the database'
            });

            response = admin.ajaxModalForm(el, '<?=$this->url('admin/shop/product/size/edit', [
                'action' => 'add',
            ]);?>');

            response.done(function(data){
                if ($.isPlainObject(data)) {
                    var selectElement = $('select[name=productSizeId]');
                    selectElement.load('<?=$this->url('admin/shop/product/size/edit', [
                        'action' => 'size-list',
                    ]);?>', null, function(){
                        selectElement.val(data.rowId);
                    });

                }
            });

            el.find('.modal-content').loadingOverlay('remove');

        });

        $('#product-weight-model').on('show.bs.modal', function(){
            $(this).find('.modal-body').load('<?=$this->url('admin/shop/post/unit/edit', [
                'action'    => 'add',
            ]);?>');
        });

        $('#product-weight-model').on('hide.bs.modal', function (e) {
            $(this).find('.modal-body').html('<i class="fa fa-spinner fa-spin"></i>&nbsp;Loading');
        });

        $('#edit-product-weight-save').on('click', function() {
            el = $('#product-weight-model');
            el.find('.modal-content').loadingOverlay({
                loadingText: 'Please wait while I update the database'
            });

            response = admin.ajaxModalForm(el, '<?=$this->url('admin/shop/post/unit/edit', [
                'action' => 'add',
            ]);?>');

            response.done(function(data){
                if ($.isPlainObject(data)) {
                    var selectElement = $('select[name=postUnitId]');
                    selectElement.load('<?=$this->url('admin/shop/post/unit/edit', [
                        'action' => 'post-list',
                    ]);?>', null, function(){
                        selectElement.val(data.rowId);
                    });

                }
            });

            el.find('.modal-content').loadingOverlay('remove');

        });
    });
</script>
